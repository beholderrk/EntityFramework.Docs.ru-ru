---
title: Миграции — EF Core
author: bricelam
ms.author: bricelam
ms.date: 10/30/2017
ms.technology: entity-framework-core
uid: core/managing-schemas/migrations/index
ms.openlocfilehash: dd164125c053497af94773011127853ad10d27a6
ms.sourcegitcommit: 72e59e6af86b568653e1b29727529dfd7f65d312
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/04/2018
ms.locfileid: "34754513"
---
<a name="migrations"></a>Миграции
==========
Миграции позволяет последовательно применять изменения схемы к базе данных, чтобы синхронизировать ее с моделью EF Core, сохраняя существующие в базе данные.

<a name="creating-the-database"></a>Создание базы данных
---------------------
После [определения начальной модели][1] можно переходить к созданию базы данных. Для этого нужно добавить первоначальную миграцию.
Установите [инструменты EF Core][2] и выполните соответствующую команду.

``` powershell
Add-Migration InitialCreate
```
``` Console
dotnet ef migrations add InitialCreate
```

В каталог **Migrations** проекта добавляются три файла.

* **00000000000000_InitialCreate.cs** — главный файл миграций. Содержит операции, необходимые для применения миграции (в `Up()`) и ее отмены (в `Down()`).
* **00000000000000_InitialCreate.Designer.cs** — файл метаданных миграций. Содержит сведения, используемые EF.
* **MyContextModelSnapshot.cs** — моментальный снимок текущей модели. Используется для определения появившихся изменений при добавлении следующей миграции.

Метка времени в именах файлов позволяет расположить их в хронологическом порядке, чтобы вы могли отслеживать ход изменений.

> [!TIP]
> Вы можете свободно перемещать файлы миграций и изменять их пространство имен. Новые миграции создаются в виде элементов того же уровня, что и последняя миграция.

После этого примените миграцию к базе данных, чтобы создать схему.

``` powershell
Update-Database
```
``` Console
dotnet ef database update
```

<a name="adding-another-migration"></a>Добавление другой миграции
------------------------
После внесения изменений в модель EF Core синхронизация схемы базы данных нарушается. Чтобы сделать ее актуальной, добавьте еще одну миграцию. Имя миграции можно использовать как сообщение фиксации в системе управления версиями. Например, если вы вносите изменения для сохранения отзывов клиентов о продуктах, можно выбрать имя *AddProductReviews*.

``` powershell
Add-Migration AddProductReviews
```
``` Console
dotnet ef migrations add AddProductReviews
```

После формирования миграции нужно проверить ее точность и добавить все операции, необходимые для ее правильного применения. Например, миграция может содержать следующие операции.

``` csharp
migrationBuilder.DropColumn(
    name: "FirstName",
    table: "Customer");

migrationBuilder.DropColumn(
    name: "LastName",
    table: "Customer");

migrationBuilder.AddColumn<string>(
    name: "Name",
    table: "Customer",
    nullable: true);
```

Хотя эти операции обеспечивают совместимость схемы базы данных, они не сохраняют существующие имена клиентов. Чтобы улучшить миграцию, перепишите ее следующим образом.

``` csharp
migrationBuilder.AddColumn<string>(
    name: "Name",
    table: "Customer",
    nullable: true);

migrationBuilder.Sql(
@"
    UPDATE Customer
    SET Name = FirstName + ' ' + LastName;
");

migrationBuilder.DropColumn(
    name: "FirstName",
    table: "Customer");

migrationBuilder.DropColumn(
    name: "LastName",
    table: "Customer");
```

> [!TIP]
> При добавлении новой миграции появляется предупреждение о том, что при формировании операции могут быть потеряны данные (например, удален столбец). Обязательно проверьте точность этих миграций.

Примените миграцию к базе данных с помощью соответствующей команды.

``` powershell
Update-Database
```
``` Console
dotnet ef database update
```

<a name="removing-a-migration"></a>Удаление миграции
--------------------
Иногда, добавив миграцию, вы понимаем, что нужно внести дополнительные изменения в модель EF Core перед ее применением.
Для удаления последней миграции используйте приведенную ниже команду.

``` powershell
Remove-Migration
```
``` Console
dotnet ef migrations remove
```

Удалив миграцию, вы можете внести в модель дополнительные изменения и снова добавить ее.

<a name="reverting-a-migration"></a>Отмена миграции
---------------------
Если вы уже применили одну миграцию для базы данных или несколько и хотите отменить их, можно использовать ту же команду, что и для применения миграций, но указав имя той миграции до которой необходимо откатиться.

``` powershell
Update-Database LastGoodMigration
```
``` Console
dotnet ef database update LastGoodMigration
```

<a name="empty-migrations"></a>Пустые миграции
----------------
Иногда бывает удобно добавить миграцию, не внося изменения в модель. В этом случае при добавлении новой миграции создается пустая миграция. Вы можете настроить ее для выполнения операций, которые не связаны напрямую с моделью EF Core.
Ниже приведен ряд вещей, которыми вам может потребоваться управлять.

* Полнотекстовый поиск
* Функции
* Хранимые процедуры
* Триггеры
* Представления
* и т. д.

<a name="generating-a-sql-script"></a>Формирование скрипта SQL
-----------------------
При отладке миграций или их развертывании в рабочей базе данных бывает полезно создать скрипт SQL. Такой скрипт можно дополнительно проверить на точность и настроить в соответствии с потребностями рабочей базы данных. Кроме того, его можно использовать в сочетании с технологией развертывания. Базовая команда имеет следующий вид.

``` powershell
Script-Migration
```
``` Console
dotnet ef migrations script
```

Для этой команды доступно несколько параметров.

Миграция **from** должна быть последней миграцией, применяемой к базе данных перед выполнением скрипта. Если не было применено ни одной миграции, укажите `0` (это значение по умолчанию).

Миграция **to** является последней миграцией, применяемой к базе данных после выполнения скрипта. По умолчанию она является последней миграцией в проекте.

При необходимости можно создать **идемпотентный** скрипт. Он применяет миграции только в том случае, если они еще не были применены к базе данных. Это удобно, если точно неизвестно, какая последняя миграция была применена к базе данных, или вы развертываете несколько баз данных, каждая из которых может иметь отдельную миграцию.

<a name="applying-migrations-at-runtime"></a>Применение миграции во время выполнения
------------------------------
Некоторым приложениям может потребоваться применить миграции во время выполнения — при запуске или первом выполнении. Для этого можно использовать метод `Migrate()`.

Обратите внимание, что такой подход не является универсальным. Хотя он отлично подходит для приложений с локальной базой данных, большинству приложений требуется более надежная стратегия развертывания, такая как создание скриптов SQL.

``` csharp
myDbContext.Database.Migrate();
```

> [!WARNING]
> Не вызывайте `EnsureCreated()` перед `Migrate()`. `EnsureCreated()` обходит миграции, чтобы создать схему, что приводит к сбою `Migrate()`.

> [!NOTE]
> Этот метод основан на службе `IMigrator`, которую можно применять в более сложных сценариях. Для доступа к нему используйте `DbContext.GetService<IMigrator>()`.


  [1]: ../../modeling/index.md
  [2]: ../../miscellaneous/cli/index.md
